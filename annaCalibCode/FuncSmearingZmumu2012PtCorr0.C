#include <SmearingTool.h>

// couldn't be inside class due to root feacher during TF1 creation:
Double_t DoubleGauss(Double_t*, Double_t* );

   const float SmearingTool::PTbin[10]={25, 30, 35, 40, 45, 50, 70, 100, 150, 300};
   const float SmearingTool::ETAbin[9]={-2.1, -1.6, -1.2, -0.8, 0, 0.8, 1.2, 1.6, 2.1};

   ////// Smearing parametrization for single muon:
   const float SmearingTool::mean[72]={
                   6.92255e-05, -0.000971291, -0.0011029, -0.00108265, -0.00107524, -0.00142073, -0.0019659, -0.00284272, -0.00583383, 
                   0.0003302, -0.000608273, -0.000531002, -0.000545614, -0.00049052, -0.000660908, -0.000480172, -0.00080472, -0.00379088, 
                   0.000595436, -6.85276e-05, -3.81977e-05, -7.11406e-05, -9.2611e-05, -0.000167457, -0.000204985, -0.000434196, -0.000759722, 
                   0.000296027, 0.00012812, 0.000121809, 9.54221e-05, 0.000103291, 6.96036e-05, 8.98588e-05, 0.000124915, -0.000984903, 
                   0.000347581, 0.000113915, 0.000110841, 9.86713e-05, 7.92619e-05, 3.43298e-05, 8.69077e-05, -0.000302805, -4.17574e-05, 
                   0.000538608, -3.0022e-05, -7.79518e-05, -0.000102278, -0.000164536, -0.000200024, -0.000345747, -0.000554513, -0.000228959, 
                   0.000274457, -0.000532305, -0.000573496, -0.000524993, -0.000610515, -0.000676472, -0.00036723, -0.000575084, -0.00033188, 
                   -4.98823e-05, -0.000958548, -0.00108406, -0.00104873, -0.00116264, -0.00133238, -0.00133133, -0.0023454, -0.00277466};
   const float SmearingTool::sig1[72]={
                   0.0177388, 0.0191759, 0.0195416, 0.0200628, 0.0204526, 0.0211721, 0.0298617, 0.0368222, 0.0552514, 
                   0.0170957, 0.0178989, 0.0182134, 0.0187132, 0.019059, 0.0198654, 0.0247488, 0.0292947, 0.0364989, 
                   0.0141821, 0.0147521, 0.0151124, 0.0154828, 0.0160099, 0.0166209, 0.0190613, 0.0245433, 0.0352209, 
                   0.00993344, 0.010358, 0.0107861, 0.0112245, 0.0116338, 0.0123527, 0.0145719, 0.0183742, 0.0307973, 
                   0.0099306, 0.0103342, 0.0107477, 0.0112109, 0.0115909, 0.0123714, 0.0146463, 0.0183835, 0.0310225, 
                   0.014187, 0.0149112, 0.015174, 0.0156733, 0.015963, 0.0167647, 0.0196116, 0.0237907, 0.035763, 
                   0.0169024, 0.0176308, 0.0179035, 0.0186486, 0.0189289, 0.0197173, 0.0246671, 0.0286054, 0.0360809, 
                   0.0180434, 0.0190998, 0.0192779, 0.0200406, 0.0201822, 0.0210844, 0.0299368, 0.0365573, 0.0502419};
   const float SmearingTool::sig2[72]={
                   0.0291768, 0.0323039, 0.032196, 0.0332284, 0.0332599, 0.0341965, 3, 3, 3, 
                   0.0312723, 0.0335092, 0.0347194, 0.0354874, 0.0363984, 0.0393214, 3, 3, 3, 
                   0.027831, 0.0290042, 0.0303612, 0.0304343, 0.0314397, 0.0328152, 0.0368258, 0.0551092, 3, 
                   0.0238626, 0.0258809, 0.0271666, 0.0288283, 0.0303291, 0.0317011, 0.0367815, 0.0402162, 3, 
                   0.0237517, 0.0249604, 0.0260948, 0.0277902, 0.0287154, 0.0310189, 0.036595, 0.0416909, 3, 
                   0.0274324, 0.0299522, 0.0299757, 0.0314266, 0.0314926, 0.0326596, 0.0400005, 0.0412164, 3, 
                   0.0309736, 0.0319558, 0.0336259, 0.0360113, 0.0361161, 0.038665, 3, 3, 3, 
                   0.030609, 0.0328333, 0.0320772, 0.0339295, 0.0333744, 0.0347565, 3, 3, 3};
   const float SmearingTool::Asig2[72]={
                   0.193918, 0.145261, 0.18077, 0.182536, 0.208435, 0.283637, 0, 0, 0, 
                   0.0767931, 0.0729819, 0.0688664, 0.0678578, 0.068866, 0.0590074, 0, 0, 0, 
                   0.0655414, 0.0697774, 0.0699088, 0.0808423, 0.0788703, 0.0878373, 0.117669, 0.0734995, 0, 
                   0.0396221, 0.0373958, 0.0381934, 0.0362512, 0.0360468, 0.0415288, 0.0509517, 0.0862463, 0, 
                   0.0390712, 0.0421013, 0.0434166, 0.0403798, 0.0424656, 0.0434504, 0.0515161, 0.0851237, 0, 
                   0.0759769, 0.0632716, 0.0779514, 0.0741283, 0.0855802, 0.0966764, 0.0831129, 0.182321, 0, 
                   0.0796962, 0.0880755, 0.0815587, 0.0627519, 0.0688941, 0.0646666, 0, 0, 0, 
                   0.144214, 0.140096, 0.204276, 0.17543, 0.228737, 0.278832, 0, 0, 0};

   const float SmearingTool::ERRmean[72]={
                   5.92758e-05, 5.03386e-05, 4.51582e-05, 4.15172e-05, 5.15868e-05, 6.76175e-05, 0.000225571, 0.000692309, 0.00278814, 
                   5.71528e-05, 4.76322e-05, 4.07691e-05, 3.51583e-05, 4.28958e-05, 5.3883e-05, 0.000168094, 0.000471897, 0.0012527, 
                   4.58525e-05, 3.75454e-05, 3.116e-05, 2.71706e-05, 3.44061e-05, 4.32832e-05, 0.000139533, 0.00041239, 0.00106398, 
                   2.07567e-05, 1.6016e-05, 1.37359e-05, 1.29689e-05, 1.67964e-05, 2.12925e-05, 6.88969e-05, 0.000202752, 0.000582826, 
                   2.08376e-05, 1.6064e-05, 1.37671e-05, 1.30336e-05, 1.68902e-05, 2.13933e-05, 6.95685e-05, 0.000206896, 0.000587872, 
                   4.63931e-05, 3.7808e-05, 3.1483e-05, 2.74944e-05, 3.47645e-05, 4.39655e-05, 0.000139971, 0.000408351, 0.00107169, 
                   5.68841e-05, 4.76434e-05, 4.07851e-05, 3.52211e-05, 4.27995e-05, 5.41607e-05, 0.000169472, 0.000461313, 0.00124217, 
                   5.83264e-05, 4.98943e-05, 4.47746e-05, 4.11772e-05, 5.1196e-05, 6.70534e-05, 0.000224269, 0.000686844, 0.0024586};
   const float SmearingTool::ERRsig1[72]={
                   0.000176885, 0.000135623, 0.000137296, 0.000129036, 0.000172286, 0.000261484, 0.000163743, 0.000542646, 0.00294088, 
                   0.000109093, 8.94904e-05, 7.41316e-05, 6.49549e-05, 7.94649e-05, 9.66276e-05, 0.000119283, 0.000341129, 0.000977712, 
                   7.56941e-05, 6.36569e-05, 5.16681e-05, 4.73506e-05, 6.06358e-05, 7.77021e-05, 0.000307255, 0.000940579, 0.000815792, 
                   2.62747e-05, 1.93972e-05, 1.66077e-05, 1.54053e-05, 1.96907e-05, 2.5788e-05, 9.03676e-05, 0.000340307, 0.000426098, 
                   2.62353e-05, 2.04463e-05, 1.71663e-05, 1.5996e-05, 2.08607e-05, 2.64726e-05, 9.216e-05, 0.000338978, 0.000430583, 
                   8.29776e-05, 6.01324e-05, 5.33615e-05, 4.66451e-05, 6.163e-05, 8.3645e-05, 0.000251066, 0.001281, 0.000827549, 
                   0.000107887, 9.44274e-05, 7.78596e-05, 6.34176e-05, 7.95703e-05, 0.000100806, 0.00012024, 0.000332051, 0.000963302, 
                   0.000155304, 0.000130204, 0.00013818, 0.000122432, 0.000174319, 0.000257272, 0.000162864, 0.000536312, 0.00239822};
   const float SmearingTool::ERRsig2[72]={
                   0.000508718, 0.000541312, 0.000458454, 0.000439188, 0.000531273, 0.000636964, 0, 0, 0, 
                   0.000688597, 0.000620222, 0.000560447, 0.000512434, 0.00063977, 0.000975971, 0, 0, 0, 
                   0.000483876, 0.000392696, 0.000324725, 0.000268717, 0.000359728, 0.000440892, 0.00157038, 0.0149375, 0, 
                   0.000226017, 0.000175683, 0.00014973, 0.000146975, 0.000193537, 0.000235671, 0.000817458, 0.00245772, 0, 
                   0.000228416, 0.00016858, 0.000140589, 0.000139807, 0.000177961, 0.000230589, 0.000822303, 0.00262523, 0, 
                   0.000465789, 0.000407198, 0.000309667, 0.000288492, 0.000342845, 0.000434406, 0.00194776, 0.00600251, 0, 
                   0.000654832, 0.000547393, 0.000494559, 0.000537518, 0.000632114, 0.000921308, 0, 0, 0, 
                   0.000582734, 0.000537332, 0.000409514, 0.000436039, 0.000487159, 0.000632871, 0, 0, 0};
   const float SmearingTool::ERRAsig2[72]={
                   0.023281, 0.0150653, 0.016899, 0.015511, 0.0223367, 0.0368933, 0, 0, 0, 
                   0.009089, 0.00682006, 0.00535805, 0.00469598, 0.00565248, 0.00618954, 0, 0, 0, 
                   0.00575329, 0.0047296, 0.00358943, 0.00352169, 0.00441128, 0.00562616, 0.0235075, 0.0536545, 0, 
                   0.00152659, 0.000984225, 0.000804782, 0.000687201, 0.0008315, 0.00111384, 0.00387211, 0.0195482, 0, 
                   0.0015332, 0.00114514, 0.000926311, 0.00078447, 0.00100864, 0.00120008, 0.00401025, 0.0186122, 0, 
                   0.00671925, 0.0041283, 0.0039507, 0.00323743, 0.00452388, 0.0062963, 0.016248, 0.125858, 0, 
                   0.00905551, 0.00814199, 0.00602386, 0.00434996, 0.00567454, 0.00669195, 0, 0, 0, 
                   0.0172761, 0.0136242, 0.0171169, 0.0137797, 0.0221123, 0.0340641, 0, 0, 0};

   const float SmearingTool::ResRMS[72]={
                   0.0210252, 0.0222618, 0.0229496, 0.0236158, 0.0241682, 0.0257188, 0.0297049, 0.0358001, 0.0460679, 
                   0.0193413, 0.0203062, 0.0206666, 0.0211374, 0.0215897, 0.0223683, 0.024731, 0.0291778, 0.0354947, 
                   0.0162945, 0.017076, 0.017658, 0.0182125, 0.0187553, 0.0197504, 0.0230542, 0.0283692, 0.0344815, 
                   0.0117885, 0.0124387, 0.0130438, 0.0136022, 0.0141865, 0.0152425, 0.018241, 0.0227088, 0.0305626, 
                   0.01174, 0.0124049, 0.0129916, 0.0135508, 0.0141062, 0.0151839, 0.0182593, 0.0230384, 0.0307916, 
                   0.016459, 0.0172271, 0.017821, 0.0184107, 0.0189264, 0.020025, 0.0231917, 0.0281555, 0.0349817, 
                   0.0192183, 0.0201268, 0.0205685, 0.0210414, 0.0214438, 0.0223464, 0.0246502, 0.0285203, 0.035189, 
                   0.0210412, 0.0223047, 0.0230774, 0.0237544, 0.0243305, 0.025876, 0.0297784, 0.0355779, 0.0440838};
   const float SmearingTool::ErrResRMS[72]={
                   4.27261e-05, 3.62719e-05, 3.2461e-05, 2.9801e-05, 3.69279e-05, 4.82224e-05, 0.000157871, 0.000462486, 0.00136084, 
                   4.14054e-05, 3.46053e-05, 2.96425e-05, 2.54916e-05, 3.11152e-05, 3.90318e-05, 0.000118721, 0.00033101, 0.000838016, 
                   3.36998e-05, 2.76506e-05, 2.30592e-05, 2.00811e-05, 2.53868e-05, 3.20343e-05, 0.000102484, 0.000292481, 0.000721503, 
                   1.58402e-05, 1.23596e-05, 1.0647e-05, 1.00887e-05, 1.3131e-05, 1.66899e-05, 5.39235e-05, 0.000152549, 0.000406239, 
                   1.58681e-05, 1.23332e-05, 1.06145e-05, 1.00759e-05, 1.3096e-05, 1.66689e-05, 5.4248e-05, 0.000156785, 0.000409646, 
                   3.41162e-05, 2.7897e-05, 2.32854e-05, 2.03573e-05, 2.57352e-05, 3.24994e-05, 0.000102771, 0.000289204, 0.000724398, 
                   4.13254e-05, 3.45499e-05, 2.97061e-05, 2.55815e-05, 3.10461e-05, 3.92883e-05, 0.0001197, 0.00032422, 0.00083594, 
                   4.20859e-05, 3.6035e-05, 3.22826e-05, 2.96491e-05, 3.67896e-05, 4.79368e-05, 0.000156942, 0.000459999, 0.00133649};

   ////// End smearing parametrization for single muon:

SmearingTool::SmearingTool(){
}
float SmearingTool::PTsmear(float PTmuonGen, float ETAmuonGen, float CHARGEmuonGen, TString ParVar,float ParSig){
   const int NPThist = (sizeof(PTbin)/sizeof(float)-1);
   const int NETAhist = (sizeof(ETAbin)/sizeof(float)-1);
   //const int Nhist = NPThist*NETAhist;
   ////// Make smearing for single muon from Gen level PostFSR:
   float PTmuonSmear = -10.;
   float meanVar = 0;
   float sigVar = 0;//for sig1 and sig2
   float Asig2Var = 0;
   if(ParVar == "mean")meanVar = ParSig;
   if(ParVar == "sig1" || ParVar == "sig2")sigVar = ParSig;
   if(ParVar == "Asig2Var")Asig2Var = ParSig;
   int iK_cand = -1;
   for(int iPT = 0; iPT < NPThist; iPT++){
   for(int iETA = 0; iETA < NETAhist; iETA++){
      int iK = iPT + iETA*NPThist;
      // smear muons which out of range PT and ETA
      float PTcutDown = PTbin[iPT];
      float PTcutUp = PTbin[iPT+1];
      if(iPT == 0 && PTmuonGen < PTbin[0])PTcutDown = PTmuonGen-0.001;
      if(iPT == (NPThist-1) && PTmuonGen > PTbin[NPThist])PTcutUp = PTmuonGen+0.001;
      float ETAcutDown = ETAbin[iETA];
      float ETAcutUp = ETAbin[iETA+1];
      if(iETA == 0 && ETAmuonGen < ETAbin[0])ETAcutDown = ETAmuonGen-0.001;
      if(iETA == (NETAhist-1) && ETAmuonGen >= ETAbin[NETAhist])ETAcutUp = ETAmuonGen+0.001;
      if(PTmuonGen >= PTcutDown && PTmuonGen < PTcutUp
      && ETAmuonGen >= ETAcutDown && ETAmuonGen < ETAcutUp) iK_cand = iK;
   }}

   ///// Set Scale Factor
   float ScaleFactor = 1.;
   if (fabs(ETAmuonGen) < 0.8) ScaleFactor = 1.2;
   if (fabs(ETAmuonGen) >= 0.8 && fabs(ETAmuonGen) < 1.2) ScaleFactor = 1.15;
   if (fabs(ETAmuonGen) >= 1.2) ScaleFactor = 1.12;
   TF1* fitDoubleGauss = new TF1("fitDoubleGauss", DoubleGauss, -0.1, 0.1, 5);
   fitDoubleGauss->SetParameter(4,1.);
   if(iK_cand > -1){
      float meanCorr = mean[iK_cand] + meanVar*ERRmean[iK_cand];
      float sig1Corr = sig1[iK_cand] + sigVar*ERRsig1[iK_cand];
      if(sig1Corr < 0.005) sig1Corr = 0.005;
      float sig2Corr = sig2[iK_cand] + sigVar*ERRsig2[iK_cand];
      if(sig2Corr < 0.005) sig2Corr = 0.005;
      float Asig2Corr = Asig2[iK_cand] + Asig2Var*ERRAsig2[iK_cand];
      if(Asig2Corr < 0.) Asig2Corr = 0.;
      fitDoubleGauss->SetParameter(0,meanCorr);
      fitDoubleGauss->SetParameter(1,ScaleFactor*sig1Corr);
      fitDoubleGauss->SetParameter(2,Asig2Corr);
      fitDoubleGauss->SetParameter(3,ScaleFactor*sig2Corr);
      Double_t resSim = fitDoubleGauss->GetRandom();
      PTmuonSmear = PTmuonGen*(1+resSim);
   }
   delete fitDoubleGauss;
   ////// End Smearing parametrization for single muon:

   return PTmuonSmear;
 }//end PTsmear function

   Double_t DoubleGauss(Double_t *x, Double_t *par)
   {
       double dgauss = 0.;
        if(par[1] < par[3]){//not normalized gauss both gauss are  = 1 at x[0]=par[0]
                  dgauss =  exp(-0.5*(x[0]-par[0])*(x[0]-par[0])/par[1]/par[1]);
                  dgauss = dgauss + par[2]*exp(-0.5*(x[0]-par[0])*(x[0]-par[0])/par[3]/par[3]);
                  dgauss = par[4]*dgauss;
        }
       return dgauss;
   }
