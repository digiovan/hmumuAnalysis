#include <SmearingTool.h>

// couldn't be inside class due to root feacher during TF1 creation:
Double_t DoubleGauss(Double_t*, Double_t* );

   const float SmearingTool::PTbin[10]={25, 30, 35, 40, 45, 50, 70, 100, 150, 300};
   const float SmearingTool::ETAbin[9]={-2.1, -1.6, -1.2, -0.8, 0, 0.8, 1.2, 1.6, 2.1};

   ////// Smearing parametrization for single muon:
   const float SmearingTool::mean[72]={
                   7.01777e-05, 0.000334881, 0.000595507, 0.000298529, 0.00034947, 0.000538335, 0.000276981, -5.02866e-05, 
                   -0.000958229, -0.000602653, -6.70674e-05, 0.000125555, 0.000115253, -2.99188e-05, -0.000529187, -0.000959301, 
                   -0.00110317, -0.000523305, -3.73238e-05, 0.000121708, 0.000111736, -7.58197e-05, -0.000570697, -0.00107809, 
                   -0.00108217, -0.000541618, -7.10416e-05, 9.59225e-05, 9.84092e-05, -9.88603e-05, -0.000519809, -0.00104499, 
                   -0.00107585, -0.000493331, -9.50093e-05, 0.000104709, 8.02791e-05, -0.000162866, -0.000607322, -0.00116279, 
                   -0.00142513, -0.000660811, -0.000168584, 7.09213e-05, 3.23954e-05, -0.000198775, -0.000679873, -0.00132977, 
                   -0.00195702, -0.000513459, -0.000199113, 9.48009e-05, 9.03143e-05, -0.000349771, -0.000365686, -0.00131306, 
                   -0.00282309, -0.000777788, -0.000428648, 0.000136561, -0.000284957, -0.000517175, -0.000583871, -0.00233631, 
                   -0.00612229, -0.00377974, -0.000924046, -0.000994701, -2.16216e-05, -0.000187193, -0.000270034, -0.00280667};
   const float SmearingTool::sig1[72]={
                   0.0177443, 0.0170995, 0.0141854, 0.00993769, 0.00993222, 0.0141863, 0.0168789, 0.0180385, 
                   0.0191674, 0.017899, 0.0147553, 0.0103599, 0.0103343, 0.0149106, 0.0176307, 0.0191009, 
                   0.0195553, 0.0182117, 0.0151073, 0.0107864, 0.0107496, 0.0151796, 0.0179044, 0.019277, 
                   0.0200599, 0.0187119, 0.0154846, 0.0112235, 0.0112092, 0.0156698, 0.0186531, 0.0200476, 
                   0.0204314, 0.0190589, 0.0160018, 0.0116347, 0.0115929, 0.0159583, 0.0189245, 0.0201941, 
                   0.021168, 0.0198621, 0.0166143, 0.0123527, 0.0123725, 0.016781, 0.0197085, 0.0210993, 
                   0.0298577, 0.0247272, 0.0190672, 0.0145652, 0.0146513, 0.0196175, 0.024672, 0.0299681, 
                   0.0368182, 0.0292744, 0.0245363, 0.0183586, 0.0183667, 0.0237355, 0.0286043, 0.0365667, 
                   0.0550787, 0.0365216, 0.0351059, 0.0308233, 0.0310172, 0.0358942, 0.0360781, 0.050458};
   const float SmearingTool::sig2[72]={
                   0.0292048, 0.0312653, 0.0278442, 0.0238996, 0.0237486, 0.0274715, 0.0308835, 0.0306122, 
                   0.032314, 0.0335344, 0.0289685, 0.0258756, 0.0249661, 0.0299329, 0.0319328, 0.0327989, 
                   0.0322242, 0.0347636, 0.0303483, 0.0271561, 0.0261214, 0.0299953, 0.0336465, 0.0320966, 
                   0.0332266, 0.0354913, 0.0304214, 0.0288197, 0.0277702, 0.0313962, 0.0360119, 0.0339326, 
                   0.0332533, 0.0363828, 0.0314146, 0.0303412, 0.0287236, 0.0315007, 0.0360825, 0.0334042, 
                   0.0342087, 0.0393525, 0.0327822, 0.0317046, 0.0310398, 0.0327177, 0.0386658, 0.0348199, 
                   3, 3, 0.0368662, 0.0367438, 0.0366274, 0.0401197, 3, 3, 
                   3, 3, 0.0549965, 0.0400168, 0.0414968, 0.0412465, 3, 3, 
                   3, 3, 3, 3, 3, 3, 3, 3};
   const float SmearingTool::Asig2[72]={
                   0.193744, 0.0769365, 0.0654621, 0.0394266, 0.0391122, 0.0755944, 0.0813762, 0.144351, 
                   0.145223, 0.0728198, 0.0702236, 0.0373752, 0.0420541, 0.0634779, 0.0884165, 0.140573, 
                   0.179989, 0.0685053, 0.0700938, 0.038228, 0.043264, 0.077639, 0.0813574, 0.203442, 
                   0.182722, 0.0679476, 0.0808662, 0.0363027, 0.0404996, 0.0743438, 0.0626268, 0.175376, 
                   0.209473, 0.068955, 0.0792604, 0.0359497, 0.0424266, 0.0856089, 0.0691731, 0.227366, 
                   0.28374, 0.0589205, 0.0882692, 0.0415282, 0.0433389, 0.0956629, 0.0647287, 0.275919, 
                   0, 0, 0.116976, 0.0513363, 0.0513148, 0.0820352, 0, 0, 
                   0, 0, 0.0742658, 0.0878931, 0.0863924, 0.182647, 0, 0, 
                   0, 0, 0, 0, 0, 0, 0, 0};

   const float SmearingTool::ERRmean[72]={
                   5.96023e-05, 5.7445e-05, 4.60647e-05, 2.08561e-05, 2.09363e-05, 4.66041e-05, 5.71581e-05, 5.86129e-05, 
                   5.05224e-05, 4.78082e-05, 3.76966e-05, 1.6071e-05, 1.61185e-05, 3.79422e-05, 4.78207e-05, 5.00822e-05, 
                   4.53047e-05, 4.08724e-05, 3.12409e-05, 1.37711e-05, 1.38019e-05, 3.15658e-05, 4.08924e-05, 4.48838e-05, 
                   4.16036e-05, 3.52298e-05, 2.72227e-05, 1.29931e-05, 1.30586e-05, 2.75401e-05, 3.52921e-05, 4.12721e-05, 
                   5.16823e-05, 4.29774e-05, 3.44606e-05, 1.68233e-05, 1.69244e-05, 3.48235e-05, 4.2874e-05, 5.12939e-05, 
                   6.77976e-05, 5.40074e-05, 4.3375e-05, 2.13414e-05, 2.14393e-05, 4.40729e-05, 5.42687e-05, 6.72085e-05, 
                   0.000226186, 0.000168386, 0.000139861, 6.90647e-05, 6.97383e-05, 0.000140264, 0.000169984, 0.000225086, 
                   0.000694651, 0.000472652, 0.00041322, 0.000203147, 0.000207339, 0.000408577, 0.000462072, 0.000688087, 
                   0.00278184, 0.00125431, 0.00106187, 0.000584487, 0.000588494, 0.00107811, 0.00124346, 0.00247667};
   const float SmearingTool::ERRsig1[72]={
                   0.000177692, 0.000110179, 7.60321e-05, 2.63826e-05, 2.63534e-05, 8.33224e-05, 0.000109226, 0.000156075, 
                   0.000136793, 8.97194e-05, 6.39606e-05, 1.94702e-05, 2.0478e-05, 6.11086e-05, 9.48955e-05, 0.000130364, 
                   0.000138002, 7.40434e-05, 5.19904e-05, 1.66546e-05, 1.71873e-05, 5.34944e-05, 7.79147e-05, 0.000137568, 
                   0.000129331, 6.51005e-05, 4.76021e-05, 1.54405e-05, 1.60317e-05, 4.68119e-05, 6.35003e-05, 0.000120985, 
                   0.000172327, 8.00691e-05, 6.08292e-05, 1.97063e-05, 2.08927e-05, 6.16981e-05, 7.96892e-05, 0.000174893, 
                   0.000262226, 9.67358e-05, 7.8133e-05, 2.58604e-05, 2.65169e-05, 8.3567e-05, 0.000100787, 0.000256121, 
                   0.000164183, 0.000119483, 0.000307453, 9.08272e-05, 9.23211e-05, 0.000250353, 0.000120604, 0.000163494, 
                   0.000544448, 0.000341628, 0.000944424, 0.000343829, 0.000340507, 0.00126696, 0.000332595, 0.000537352, 
                   0.00292398, 0.000979272, 0.000812983, 0.000427406, 0.000431019, 0.000833975, 0.000964253, 0.00242468};
   const float SmearingTool::ERRsig2[72]={
                   0.000511687, 0.000694484, 0.000486584, 0.000227699, 0.000229324, 0.000469654, 0.000650596, 0.000584391, 
                   0.000546412, 0.000623401, 0.00039274, 0.00017644, 0.000169124, 0.000413821, 0.000548515, 0.000536226, 
                   0.000462666, 0.000562552, 0.000326346, 0.000150051, 0.000141138, 0.000311496, 0.000495967, 0.000409201, 
                   0.000439477, 0.000513279, 0.000269974, 0.000147134, 0.00013983, 0.000288629, 0.000539201, 0.000431737, 
                   0.000528245, 0.0006452, 0.000359271, 0.000194068, 0.000178402, 0.00034309, 0.000628943, 0.000492062, 
                   0.000638106, 0.000978638, 0.000441217, 0.000236307, 0.000231565, 0.00043865, 0.000919225, 0.000636861, 
                   0, 0, 0.00158087, 0.0008157, 0.000827207, 0.00197122, 0, 0, 
                   0, 0, 0.0148079, 0.00242792, 0.00259095, 0.00592212, 0, 0, 
                   0, 0, 0, 0, 0, 0, 0, 0};
   const float SmearingTool::ERRAsig2[72]={
                   0.0233373, 0.00919701, 0.00577366, 0.00152672, 0.00154122, 0.00671778, 0.00924873, 0.017336, 
                   0.0151842, 0.00682474, 0.00477545, 0.000988578, 0.00114677, 0.00422393, 0.00820633, 0.0136852, 
                   0.0169514, 0.00532858, 0.00362094, 0.000807875, 0.000924842, 0.00395371, 0.0060155, 0.0169885, 
                   0.0155398, 0.00470743, 0.00354386, 0.000689294, 0.000787877, 0.00325625, 0.00435555, 0.0136248, 
                   0.0223126, 0.00571387, 0.00443469, 0.000830936, 0.00100978, 0.004524, 0.0056863, 0.0221433, 
                   0.0369291, 0.00618196, 0.00567262, 0.00111671, 0.00120007, 0.00626531, 0.00667933, 0.0337038, 
                   0, 0, 0.0234533, 0.00390248, 0.00401092, 0.0160878, 0, 0, 
                   0, 0, 0.0540582, 0.019959, 0.0188717, 0.124015, 0, 0, 
                   0, 0, 0, 0, 0, 0, 0, 0};

   const float SmearingTool::ResRMS[72]={
                   0.0210371, 0.0193458, 0.016298, 0.0117923, 0.0117418, 0.0164595, 0.0192201, 0.0210415, 
                   0.0222596, 0.0203078, 0.0170808, 0.0124376, 0.0124045, 0.0172284, 0.0201287, 0.0223027, 
                   0.0229566, 0.0206641, 0.017657, 0.0130429, 0.0129931, 0.0178214, 0.0205689, 0.0230738, 
                   0.0236163, 0.02114, 0.0182107, 0.0136023, 0.0135506, 0.0184067, 0.0210405, 0.0237583, 
                   0.0241678, 0.0215891, 0.0187545, 0.0141841, 0.0141077, 0.0189268, 0.0214423, 0.0243317, 
                   0.0257235, 0.0223683, 0.0197491, 0.0152433, 0.0151839, 0.0200249, 0.0223427, 0.0258782, 
                   0.029701, 0.0247102, 0.0230519, 0.0182502, 0.0182585, 0.0231852, 0.024656, 0.0298084, 
                   0.0357976, 0.0291597, 0.028384, 0.0227107, 0.0230321, 0.0281419, 0.0285194, 0.0355844, 
                   0.0459987, 0.0355127, 0.0343881, 0.0305879, 0.0307871, 0.0350905, 0.0351888, 0.0441794};
   const float SmearingTool::ErrResRMS[72]={
                   4.29667e-05, 4.16156e-05, 3.38566e-05, 1.59176e-05, 1.59427e-05, 3.42773e-05, 4.1532e-05, 4.22986e-05, 
                   3.64082e-05, 3.4736e-05, 2.77578e-05, 1.23998e-05, 1.23754e-05, 2.79938e-05, 3.46773e-05, 3.61669e-05, 
                   3.25648e-05, 2.97201e-05, 2.31205e-05, 1.06731e-05, 1.06422e-05, 2.33453e-05, 2.97859e-05, 3.23635e-05, 
                   2.98639e-05, 2.55452e-05, 2.01172e-05, 1.01075e-05, 1.00951e-05, 2.03903e-05, 2.56306e-05, 2.97158e-05, 
                   3.70022e-05, 3.11732e-05, 2.54294e-05, 1.31514e-05, 1.31223e-05, 2.57825e-05, 3.10995e-05, 3.68593e-05, 
                   4.83527e-05, 3.91246e-05, 3.21016e-05, 1.67283e-05, 1.67058e-05, 3.2574e-05, 3.93727e-05, 4.80507e-05, 
                   0.000158303, 0.000118931, 0.000102724, 5.40723e-05, 5.4376e-05, 0.000103002, 0.000120066, 0.000157498, 
                   0.000464083, 0.000331575, 0.000293101, 0.00015281, 0.000157085, 0.000289493, 0.000324756, 0.000460777, 
                   0.00136117, 0.000838908, 0.000720813, 0.000407368, 0.000410094, 0.0007279, 0.00083688, 0.00134062};

   ////// End smearing parametrization for single muon:

SmearingTool::SmearingTool(){
}
float SmearingTool::PTsmear(float PTmuonGen, float ETAmuonGen, float CHARGEmuonGen, TString ParVar,float ParSig){
   const int NPThist = (sizeof(PTbin)/sizeof(float)-1);
   const int NETAhist = (sizeof(ETAbin)/sizeof(float)-1);
   //const int Nhist = NPThist*NETAhist;
   ////// Make smearing for single muon from Gen level PostFSR:
   Float_t PTmuonSmear = -10.;
   float meanVar = 0;
   float sigVar = 0;//for sig1 and sig2
   float Asig2Var = 0;
   if(ParVar == "mean")meanVar = ParSig;
   if(ParVar == "sig1" || ParVar == "sig2")sigVar = ParSig;
   if(ParVar == "Asig2Var")Asig2Var = ParSig;
   int iK_cand = -1;
   for(int iPT = 0; iPT < NPThist; iPT++){
   for(int iETA = 0; iETA < NETAhist; iETA++){
      int iK = iPT + iETA*NPThist;
      // smear muons which out of range PT and ETA
      float PTcutDown = PTbin[iPT];
      float PTcutUp = PTbin[iPT+1];
      if(iPT == 0 && PTmuonGen < PTbin[0])PTcutDown = PTmuonGen-0.001;
      if(iPT == (NPThist-1) && PTmuonGen > PTbin[NPThist])PTcutUp = PTmuonGen+0.001;
      float ETAcutDown = ETAbin[iETA];
      float ETAcutUp = ETAbin[iETA+1];
      if(iETA == 0 && ETAmuonGen < ETAbin[0])ETAcutDown = ETAmuonGen-0.001;
      if(iETA == (NETAhist-1) && ETAmuonGen >= ETAbin[NETAhist])ETAcutUp = ETAmuonGen+0.001;
      if(PTmuonGen >= PTcutDown && PTmuonGen < PTcutUp
      && ETAmuonGen >= ETAcutDown && ETAmuonGen < ETAcutUp) iK_cand = iK;
   }}

   ///// Set Scale Factor
   float ScaleFactor = 1.;
   if (fabs(ETAmuonGen) < 0.8) ScaleFactor = sqrt(1.2);
   if (fabs(ETAmuonGen) >= 0.8 && fabs(ETAmuonGen) < 1.2) ScaleFactor = sqrt(1.15);
   if (fabs(ETAmuonGen) >= 1.2) ScaleFactor = sqrt(1.12);
   TF1* fitDoubleGauss = new TF1("fitDoubleGauss", DoubleGauss, -0.1, 0.1, 5);
   fitDoubleGauss->SetParameter(4,1.);
   if(iK_cand > -1){
      float meanCorr = mean[iK_cand] + meanVar*ERRmean[iK_cand];
      float sig1Corr = sig1[iK_cand] + sigVar*ERRsig1[iK_cand];
      if(sig1Corr < 0.005) sig1Corr = 0.005;
      float sig2Corr = sig2[iK_cand] + sigVar*ERRsig2[iK_cand];
      if(sig2Corr < 0.005) sig2Corr = 0.005;
      float Asig2Corr = Asig2[iK_cand] + Asig2Var*ERRAsig2[iK_cand];
      if(Asig2Corr < 0.) Asig2Corr = 0.;
      fitDoubleGauss->SetParameter(0,meanCorr);
      fitDoubleGauss->SetParameter(1,ScaleFactor*sig1Corr);
      fitDoubleGauss->SetParameter(2,Asig2Corr);
      fitDoubleGauss->SetParameter(3,ScaleFactor*sig2Corr);
      Double_t resSim = fitDoubleGauss->GetRandom();
      PTmuonSmear = PTmuonGen*(1+resSim);
   }
   delete fitDoubleGauss;
   ////// End Smearing parametrization for single muon:

   return PTmuonSmear;
 }//end PTsmear function

   Double_t DoubleGauss(Double_t *x, Double_t *par)
   {
       double dgauss = 0.;
        if(par[1] < par[3]){//not normalized gauss both gauss are  = 1 at x[0]=par[0]
                  dgauss =  exp(-0.5*(x[0]-par[0])*(x[0]-par[0])/par[1]/par[1]);
                  dgauss = dgauss + par[2]*exp(-0.5*(x[0]-par[0])*(x[0]-par[0])/par[3]/par[3]);
                  dgauss = par[4]*dgauss;
        }
       return dgauss;
   }
