#include <SmearingTool.h>

// couldn't be inside class due to root feacher during TF1 creation:
Double_t DoubleGauss(Double_t*, Double_t* );

   const float SmearingTool::PTbin[10]={25, 30, 35, 40, 45, 50, 70, 100, 150, 300};
   const float SmearingTool::ETAbin[9]={-2.1, -1.6, -1.2, -0.8, 0, 0.8, 1.2, 1.6, 2.1};

   ////// Smearing parametrization for single muon:
   const float SmearingTool::mean[72]={
                   0.00171083, 0.00070023, 0.000589802, 0.000588137, 0.00062088, 0.000320539, -0.000516864, -0.00131559, -0.00861284, 
                   0.00122492, 0.000316569, 0.000349185, 0.000342841, 0.000385343, 0.000194205, 0.000409474, -0.000439755, -0.00466172, 
                   0.000783384, 7.64523e-05, 0.000134685, 0.000114491, 7.53914e-05, -6.43696e-06, -0.000179409, -0.000141624, -0.00188791, 
                   8.74668e-05, -0.000132904, -0.000144454, -0.000151305, -0.000158725, -0.000168418, -0.000146222, -0.000220057, -0.00115367, 
                   0.000262656, -2.87904e-05, -9.55335e-06, -2.77438e-05, -5.71367e-05, -0.000138868, -0.000126014, -0.000342364, -0.00130535, 
                   0.000775861, 0.000184404, 0.000139045, 0.000112227, 5.30734e-05, 1.52583e-05, -0.000158236, 0.000377548, -0.00139149, 
                   0.00119813, 0.000416033, 0.0003253, 0.00037512, 0.000315196, 0.000193916, 0.000473747, 0.000294193, -0.000320658, 
                   0.00158622, 0.000703986, 0.000569289, 0.000608896, 0.000513707, 0.000300492, 0.000314009, -0.00043272, -0.000436811};
   const float SmearingTool::sig1[72]={
                   0.0184235, 0.0198129, 0.0203689, 0.0211351, 0.0217374, 0.0222817, 0.0319181, 0.0392909, 0.0540074, 
                   0.0177408, 0.0187855, 0.0192467, 0.0200451, 0.0206759, 0.0220051, 0.0281089, 0.0346553, 0.0463058, 
                   0.014908, 0.0158889, 0.0165502, 0.0172129, 0.0180312, 0.0192578, 0.0234668, 0.029787, 0.04711, 
                   0.0110652, 0.0118815, 0.0126567, 0.0135111, 0.0143348, 0.015704, 0.0199494, 0.0275108, 0.0424771, 
                   0.0110908, 0.0118756, 0.0126471, 0.0134699, 0.0142528, 0.0157249, 0.0198653, 0.0280927, 0.0443888, 
                   0.0150218, 0.0159053, 0.0165563, 0.0173284, 0.017974, 0.0193285, 0.0239838, 0.0311818, 0.0481534, 
                   0.0174799, 0.0183967, 0.0191267, 0.0200064, 0.0206635, 0.021781, 0.0282023, 0.034964, 0.0466644, 
                   0.0183972, 0.0198757, 0.0202274, 0.0210911, 0.0215371, 0.0222641, 0.0320579, 0.0411259, 0.0544945};
   const float SmearingTool::sig2[72]={
                   0.0301589, 0.0323946, 0.0330569, 0.0343685, 0.0344929, 0.0342529, 3, 3, 3, 
                   0.0320708, 0.0342494, 0.0351145, 0.0363173, 0.037994, 0.0413781, 3, 3, 3, 
                   0.0284509, 0.0302577, 0.0319992, 0.0322449, 0.0332975, 0.0353676, 0.0422951, 0.0429769, 3, 
                   0.0252536, 0.0278839, 0.0291868, 0.0313883, 0.0335791, 0.0345768, 0.0395259, 0.0626956, 3, 
                   0.0252017, 0.0266673, 0.0281685, 0.0299298, 0.0313511, 0.0338864, 0.0389989, 0.0758359, 3, 
                   0.0284508, 0.0306151, 0.0313117, 0.0328168, 0.0336859, 0.0344794, 0.0479756, 0.0465985, 3, 
                   0.0310605, 0.0319763, 0.0352608, 0.0367769, 0.0382715, 0.0391389, 3, 3, 3, 
                   0.0306548, 0.0335159, 0.0327404, 0.0343993, 0.0342653, 0.0349601, 3, 3, 3};
   const float SmearingTool::Asig2[72]={
                   0.162684, 0.1474, 0.16897, 0.164337, 0.191996, 0.351486, 0, 0, 0, 
                   0.0738352, 0.0714314, 0.074358, 0.0709077, 0.0692416, 0.0591873, 0, 0, 0, 
                   0.0663465, 0.0644522, 0.0636485, 0.0734363, 0.073522, 0.0828043, 0.0972098, 0.4, 0, 
                   0.0358183, 0.0327857, 0.0349416, 0.032476, 0.0314289, 0.042509, 0.0642759, 0.0526103, 0, 
                   0.0347793, 0.0380399, 0.0396292, 0.0379877, 0.0393371, 0.0436484, 0.0690163, 0.0335616, 0, 
                   0.0700897, 0.066003, 0.073653, 0.072937, 0.0780389, 0.103242, 0.0610142, 0.212547, 0, 
                   0.0865163, 0.100889, 0.074214, 0.0661047, 0.0626445, 0.0789656, 0, 0, 0, 
                   0.156018, 0.129171, 0.197764, 0.179728, 0.220956, 0.345068, 0, 0, 0};

   const float SmearingTool::ERRmean[72]={
                   6.03225e-05, 5.15692e-05, 4.65183e-05, 4.30289e-05, 5.39083e-05, 7.10878e-05, 0.000242099, 0.00075122, 0.00275942, 
                   5.90028e-05, 4.9647e-05, 4.29589e-05, 3.74544e-05, 4.62224e-05, 5.92396e-05, 0.000191402, 0.000567071, 0.00173861, 
                   4.79807e-05, 3.99346e-05, 3.36108e-05, 2.9652e-05, 3.80223e-05, 4.90662e-05, 0.000166185, 0.000521026, 0.00156513, 
                   2.28103e-05, 1.8055e-05, 1.58284e-05, 1.52975e-05, 2.02324e-05, 2.65282e-05, 9.23057e-05, 0.000293032, 0.000861781, 
                   2.29435e-05, 1.81283e-05, 1.58902e-05, 1.53577e-05, 2.03138e-05, 2.6603e-05, 9.27291e-05, 0.000297573, 0.000916825, 
                   4.86003e-05, 4.01301e-05, 3.38705e-05, 2.99887e-05, 3.83925e-05, 4.98793e-05, 0.000166296, 0.000529989, 0.00159373, 
                   5.87954e-05, 4.97567e-05, 4.30879e-05, 3.7588e-05, 4.61635e-05, 5.9763e-05, 0.000193981, 0.000574094, 0.00177143, 
                   5.94951e-05, 5.1226e-05, 4.63272e-05, 4.28642e-05, 5.35803e-05, 7.08745e-05, 0.000241407, 0.000794003, 0.00281444};
   const float SmearingTool::ERRsig1[72]={
                   0.000170958, 0.000151745, 0.000144915, 0.000138761, 0.000200699, 0.000318889, 0.000178792, 0.000610643, 0.00283055, 
                   0.000114362, 9.75771e-05, 8.72187e-05, 7.94373e-05, 9.65439e-05, 0.000124738, 0.000137395, 0.000431697, 0.00158432, 
                   8.16197e-05, 6.91789e-05, 5.77857e-05, 5.54071e-05, 7.31691e-05, 0.000101273, 0.000480976, 0.00106882, 0.00144831, 
                   2.89396e-05, 2.19347e-05, 1.96645e-05, 1.8776e-05, 2.48437e-05, 3.60662e-05, 0.000173922, 0.000869695, 0.000737427, 
                   2.91543e-05, 2.31553e-05, 2.0556e-05, 1.97617e-05, 2.69384e-05, 3.74016e-05, 0.000171641, 0.000722264, 0.000810109, 
                   8.56981e-05, 6.93225e-05, 6.07596e-05, 5.39035e-05, 7.28238e-05, 0.000113886, 0.000404796, 0.00646686, 0.0015016, 
                   0.000119211, 0.000109869, 8.58815e-05, 7.6067e-05, 9.57123e-05, 0.000144581, 0.000139315, 0.000438738, 0.0016272, 
                   0.000162247, 0.000137633, 0.000155536, 0.000140582, 0.000207575, 0.000344962, 0.000178521, 0.000664522, 0.00295258};
   const float SmearingTool::ERRsig2[72]={
                   0.000592915, 0.000613286, 0.00053482, 0.000548958, 0.000706513, 0.00065241, 0, 0, 0, 
                   0.000767416, 0.000722769, 0.000645432, 0.00064419, 0.000852031, 0.00144016, 0, 0, 0, 
                   0.000530688, 0.000476165, 0.000418023, 0.000365685, 0.000505111, 0.000687462, 0.00389045, 0.00162594, 0, 
                   0.000275445, 0.000228092, 0.000199383, 0.00021063, 0.000302515, 0.000370235, 0.00163772, 0.0244642, 0, 
                   0.00028305, 0.000214883, 0.000189038, 0.000192998, 0.000266215, 0.000370173, 0.0015084, 0.0740662, 0, 
                   0.000531294, 0.000469912, 0.000389796, 0.000365304, 0.000481483, 0.000630696, 0.00587441, 0.0353836, 0, 
                   0.000692284, 0.00058438, 0.000633761, 0.000659596, 0.000920157, 0.00121975, 0, 0, 0, 
                   0.000581654, 0.000633973, 0.000494483, 0.000513696, 0.000636448, 0.0007404, 0, 0, 0};
   const float SmearingTool::ERRAsig2[72]={
                   0.0214972, 0.0181546, 0.0180282, 0.0168801, 0.026799, 0.0522527, 0, 0, 0, 
                   0.0095489, 0.00778733, 0.00696794, 0.00635022, 0.00742618, 0.0089289, 0, 0, 0, 
                   0.00644363, 0.00522314, 0.00410875, 0.00428862, 0.0057605, 0.00811443, 0.0407785, 0.38278, 0, 
                   0.00167115, 0.00109735, 0.000984978, 0.00087481, 0.00109691, 0.00184224, 0.0112599, 0.0491502, 0, 
                   0.00168288, 0.00131897, 0.0011433, 0.00104213, 0.00141759, 0.00200425, 0.011466, 0.0337316, 0, 
                   0.00691464, 0.00512476, 0.00469736, 0.00406107, 0.00560724, 0.0101626, 0.0264309, 0.22471, 0, 
                   0.0108335, 0.0106325, 0.00668975, 0.00580412, 0.00710823, 0.0119539, 0, 0, 0, 
                   0.0191661, 0.0147114, 0.0202739, 0.0173166, 0.0284776, 0.0541549, 0, 0, 0};

   const float SmearingTool::ResRMS[72]={
                   0.0213705, 0.0226962, 0.0235394, 0.0243347, 0.025085, 0.0268241, 0.0316202, 0.0376531, 0.0455497, 
                   0.0198919, 0.0210258, 0.0216035, 0.0223093, 0.0230206, 0.024227, 0.0280298, 0.0340249, 0.0420899, 
                   0.0169424, 0.0179766, 0.0187979, 0.0195693, 0.0203604, 0.0218923, 0.0264693, 0.0338164, 0.0425713, 
                   0.0126815, 0.0136332, 0.0145164, 0.0154004, 0.016304, 0.0179845, 0.0226514, 0.0301223, 0.0398399, 
                   0.0126466, 0.0136083, 0.0145067, 0.0153544, 0.0162298, 0.0179148, 0.0226569, 0.0301855, 0.0410237, 
                   0.0171139, 0.018116, 0.0189223, 0.0197665, 0.0205349, 0.0222079, 0.0266124, 0.0339378, 0.0431269, 
                   0.019768, 0.0209026, 0.0215499, 0.0222376, 0.0228696, 0.0242722, 0.0281183, 0.0342779, 0.0423192, 
                   0.0214313, 0.0227803, 0.0237307, 0.0245372, 0.0252486, 0.0270779, 0.0317408, 0.0389545, 0.045871};
   const float SmearingTool::ErrResRMS[72]={
                   4.33694e-05, 3.69818e-05, 3.32975e-05, 3.07092e-05, 3.83271e-05, 5.03034e-05, 0.000168017, 0.000488056, 0.00136594, 
                   4.25912e-05, 3.58366e-05, 3.09853e-05, 2.69059e-05, 3.31793e-05, 4.22846e-05, 0.000134619, 0.000386547, 0.00101252, 
                   3.50425e-05, 2.91148e-05, 2.45475e-05, 2.15768e-05, 2.75596e-05, 3.55095e-05, 0.000117689, 0.000349759, 0.000902713, 
                   1.705e-05, 1.35449e-05, 1.18481e-05, 1.1422e-05, 1.50904e-05, 1.96915e-05, 6.69523e-05, 0.000202688, 0.000536129, 
                   1.71024e-05, 1.35281e-05, 1.18509e-05, 1.14171e-05, 1.50684e-05, 1.96667e-05, 6.73241e-05, 0.000205825, 0.000553667, 
                   3.54823e-05, 2.93393e-05, 2.47258e-05, 2.18575e-05, 2.79232e-05, 3.60503e-05, 0.000117904, 0.000349596, 0.000902798, 
                   4.25012e-05, 3.58837e-05, 3.11232e-05, 2.70364e-05, 3.3111e-05, 4.26839e-05, 0.000136397, 0.000390278, 0.00103003, 
                   4.2815e-05, 3.68025e-05, 3.31953e-05, 3.06285e-05, 3.81863e-05, 5.0185e-05, 0.000167382, 0.000503825, 0.00141025};

   ////// End smearing parametrization for single muon:

SmearingTool::SmearingTool(){
}
float SmearingTool::PTsmear(float PTmuonGen, float ETAmuonGen, float CHARGEmuonGen, TString ParVar,float ParSig){
   const int NPThist = (sizeof(PTbin)/sizeof(float)-1);
   const int NETAhist = (sizeof(ETAbin)/sizeof(float)-1);
   //const int Nhist = NPThist*NETAhist;
   ////// Make smearing for single muon from Gen level PostFSR:
   float PTmuonSmear = -10.;
   float meanVar = 0;
   float sigVar = 0;//for sig1 and sig2
   float Asig2Var = 0;
   if(ParVar == "mean")meanVar = ParSig;
   if(ParVar == "sig1" || ParVar == "sig2")sigVar = ParSig;
   if(ParVar == "Asig2Var")Asig2Var = ParSig;
   int iK_cand = -1;
   for(int iPT = 0; iPT < NPThist; iPT++){
   for(int iETA = 0; iETA < NETAhist; iETA++){
      int iK = iPT + iETA*NPThist;
      // smear muons which out of range PT and ETA
      float PTcutDown = PTbin[iPT];
      float PTcutUp = PTbin[iPT+1];
      if(iPT == 0 && PTmuonGen < PTbin[0])PTcutDown = PTmuonGen-0.001;
      if(iPT == (NPThist-1) && PTmuonGen > PTbin[NPThist])PTcutUp = PTmuonGen+0.001;
      float ETAcutDown = ETAbin[iETA];
      float ETAcutUp = ETAbin[iETA+1];
      if(iETA == 0 && ETAmuonGen < ETAbin[0])ETAcutDown = ETAmuonGen-0.001;
      if(iETA == (NETAhist-1) && ETAmuonGen >= ETAbin[NETAhist])ETAcutUp = ETAmuonGen+0.001;
      if(PTmuonGen >= PTcutDown && PTmuonGen < PTcutUp
      && ETAmuonGen >= ETAcutDown && ETAmuonGen < ETAcutUp) iK_cand = iK;
   }}

   ///// Set Scale Factor
   float ScaleFactor = 1.;
   if (fabs(ETAmuonGen) < 0.8) ScaleFactor = 0.97;
   if (fabs(ETAmuonGen) >= 0.8 && fabs(ETAmuonGen) < 1.2) ScaleFactor = 0.99;
   if (fabs(ETAmuonGen) >= 1.2) ScaleFactor = 1.05;
   TF1* fitDoubleGauss = new TF1("fitDoubleGauss", DoubleGauss, -0.1, 0.1, 5);
   fitDoubleGauss->SetParameter(4,1.);
   if(iK_cand > -1){
      float meanCorr = mean[iK_cand] + meanVar*ERRmean[iK_cand];
      float sig1Corr = sig1[iK_cand] + sigVar*ERRsig1[iK_cand];
      if(sig1Corr < 0.005) sig1Corr = 0.005;
      float sig2Corr = sig2[iK_cand] + sigVar*ERRsig2[iK_cand];
      if(sig2Corr < 0.005) sig2Corr = 0.005;
      float Asig2Corr = Asig2[iK_cand] + Asig2Var*ERRAsig2[iK_cand];
      if(Asig2Corr < 0.) Asig2Corr = 0.;
      fitDoubleGauss->SetParameter(0,meanCorr);
      fitDoubleGauss->SetParameter(1,ScaleFactor*sig1Corr);
      fitDoubleGauss->SetParameter(2,Asig2Corr);
      fitDoubleGauss->SetParameter(3,ScaleFactor*sig2Corr);
      Double_t resSim = fitDoubleGauss->GetRandom();
      PTmuonSmear = PTmuonGen*(1+resSim);
   }
   delete fitDoubleGauss;
   ////// End Smearing parametrization for single muon:

   return PTmuonSmear;
 }//end PTsmear function

   Double_t DoubleGauss(Double_t *x, Double_t *par)
   {
       double dgauss = 0.;
        if(par[1] < par[3]){//not normalized gauss both gauss are  = 1 at x[0]=par[0]
                  dgauss =  exp(-0.5*(x[0]-par[0])*(x[0]-par[0])/par[1]/par[1]);
                  dgauss = dgauss + par[2]*exp(-0.5*(x[0]-par[0])*(x[0]-par[0])/par[3]/par[3]);
                  dgauss = par[4]*dgauss;
        }
       return dgauss;
   }
