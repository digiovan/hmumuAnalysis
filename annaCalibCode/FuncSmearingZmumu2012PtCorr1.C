#include <SmearingTool.h>

// couldn't be inside class due to root feacher during TF1 creation:
Double_t DoubleGauss(Double_t*, Double_t* );

   const float SmearingTool::PTbin[14]={25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 80, 100, 150, 300};
   const float SmearingTool::ETAbin[9]={-2.1, -1.6, -1.2, -0.8, 0, 0.8, 1.2, 1.6, 2.1};

   ////// Smearing parametrization for single muon:
   const float SmearingTool::mean[104]={
                   0.00171083, 0.00070023, 0.000589802, 0.000588137, 0.00062088, 0.000465748, 0.000234661, 5.48511e-05, 1.33321e-05, -0.000687083, -0.000239922, -0.00131559, -0.00861284, 
                   0.00122492, 0.000316569, 0.000349185, 0.000342841, 0.000385343, 0.000102607, 0.000497794, 0.000142315, 1.88143e-05, 0.00037882, 0.000459144, -0.000439755, -0.00466172, 
                   0.000783384, 7.64523e-05, 0.000134685, 0.000114491, 7.53914e-05, 1.32079e-05, 9.34149e-05, -0.000172995, -0.000162742, -0.000184153, -0.000124805, -0.000141622, -0.00188791, 
                   8.74668e-05, -0.000132904, -0.000144454, -0.000151305, -0.000158725, -0.000228923, -0.000104221, -0.000109227, -2.3189e-05, -0.000142769, -0.000128692, -0.000220058, -0.00115367, 
                   0.000262656, -2.87904e-05, -9.55335e-06, -2.77438e-05, -5.71367e-05, -9.22072e-05, -0.000165967, -0.000192644, -0.000273029, -9.87517e-05, -0.000144576, -0.000342364, -0.00130535, 
                   0.000775861, 0.000184404, 0.000139045, 0.000112227, 5.30734e-05, 9.82246e-05, -6.12805e-05, -0.000199409, 7.4533e-05, -0.000372436, 0.000232647, 0.000377574, -0.00139149, 
                   0.00119813, 0.000416033, 0.0003253, 0.00037512, 0.000315196, 0.000232359, 0.000257783, -9.38835e-05, 0.000250471, 0.000172085, 0.000953924, 0.000294193, -0.000320658, 
                   0.00158622, 0.000703986, 0.000569289, 0.000608896, 0.000513707, 0.00047705, 0.000139344, -0.000126722, 0.000272085, 0.000468142, 6.00798e-05, -0.00043272, -0.000436733};
   const float SmearingTool::sig1[104]={
                   0.0184235, 0.0198129, 0.0203689, 0.0211351, 0.0217374, 0.021828, 0.0225305, 0.0246392, 0.0240969, 0.0307293, 0.0338091, 0.0392909, 0.0540074, 
                   0.0177408, 0.0187855, 0.0192467, 0.0200451, 0.0206759, 0.0215029, 0.0222412, 0.023329, 0.0230973, 0.0273286, 0.0293319, 0.0346553, 0.0463058, 
                   0.014908, 0.0158889, 0.0165502, 0.0172129, 0.0180312, 0.0187669, 0.0196029, 0.0197203, 0.0214473, 0.0227084, 0.025245, 0.0297871, 0.04711, 
                   0.0110652, 0.0118815, 0.0126567, 0.0135111, 0.0143348, 0.0150374, 0.0161236, 0.0168542, 0.0176856, 0.0189359, 0.021941, 0.0275102, 0.0424771, 
                   0.0110908, 0.0118756, 0.0126471, 0.0134699, 0.0142528, 0.0150652, 0.0160162, 0.0168735, 0.0181213, 0.0193508, 0.0209091, 0.0280927, 0.0443888, 
                   0.0150218, 0.0159053, 0.0165563, 0.0173284, 0.017974, 0.0187397, 0.0197435, 0.0205565, 0.0213936, 0.0232849, 0.0254693, 0.0311783, 0.0481534, 
                   0.0174799, 0.0183967, 0.0191267, 0.0200064, 0.0206635, 0.0212143, 0.0224612, 0.0229907, 0.0213636, 0.0274461, 0.0293683, 0.034964, 0.0466644, 
                   0.0183972, 0.0198757, 0.0202274, 0.0210911, 0.0215371, 0.0216959, 0.0226428, 0.0230784, 0.0253094, 0.0307638, 0.0341373, 0.0411259, 0.0544944};
   const float SmearingTool::sig2[104]={
                   0.0301589, 0.0323946, 0.0330569, 0.0343685, 0.0344929, 0.0337128, 0.033939, 0.0396382, 0.036649, 3, 3, 3, 3, 
                   0.0320708, 0.0342494, 0.0351145, 0.0363173, 0.037994, 0.04152, 0.0403607, 0.0490489, 0.0390625, 3, 3, 3, 3, 
                   0.0284509, 0.0302577, 0.0319992, 0.0322449, 0.0332975, 0.0358817, 0.0358739, 0.0326585, 0.0402156, 0.0445296, 0.0419597, 0.0429768, 3, 
                   0.0252536, 0.0278839, 0.0291868, 0.0313883, 0.0335791, 0.0333232, 0.0368006, 0.0366519, 0.038781, 0.0374682, 0.0463679, 0.0626785, 3, 
                   0.0252017, 0.0266673, 0.0281685, 0.0299298, 0.0313511, 0.0327963, 0.0342107, 0.0370647, 0.0424509, 0.041915, 0.0371622, 0.075836, 3, 
                   0.0284508, 0.0306151, 0.0313117, 0.0328168, 0.0336859, 0.0340048, 0.0354849, 0.0356212, 0.0366712, 0.0517429, 0.0462829, 0.0465814, 3, 
                   0.0310605, 0.0319763, 0.0352608, 0.0367769, 0.0382715, 0.0378449, 0.0470742, 0.0407102, 0.0330524, 3, 3, 3, 3, 
                   0.0306548, 0.0335159, 0.0327404, 0.0343993, 0.0342653, 0.0340879, 0.0342359, 0.0364943, 0.0423345, 3, 3, 3, 3};
   const float SmearingTool::Asig2[104]={
                   0.162684, 0.1474, 0.16897, 0.164337, 0.191996, 0.311247, 0.4, 0.175764, 0.4, 0, 0, 0, 0, 
                   0.0738352, 0.0714314, 0.074358, 0.0709077, 0.0692416, 0.0527601, 0.0655509, 0.0340574, 0.113988, 0, 0, 0, 0, 
                   0.0663465, 0.0644522, 0.0636485, 0.0734363, 0.073522, 0.0675983, 0.0754438, 0.164423, 0.0632199, 0.0641397, 0.122923, 0.4, 0, 
                   0.0358183, 0.0327857, 0.0349416, 0.032476, 0.0314289, 0.0415699, 0.033709, 0.0401455, 0.0428977, 0.0615765, 0.0462298, 0.0526444, 0, 
                   0.0347793, 0.0380399, 0.0396292, 0.0379877, 0.0393371, 0.0415444, 0.0420886, 0.0398423, 0.0270547, 0.0410765, 0.115228, 0.0335616, 0, 
                   0.0700897, 0.066003, 0.073653, 0.072937, 0.0780389, 0.0902, 0.090974, 0.114313, 0.119497, 0.0432513, 0.0762906, 0.21307, 0, 
                   0.0865163, 0.100889, 0.074214, 0.0661047, 0.0626445, 0.0803028, 0.0406554, 0.0736338, 0.336631, 0, 0, 0, 0, 
                   0.156018, 0.129171, 0.197764, 0.179728, 0.220956, 0.322408, 0.4, 0.4, 0.201524, 0, 0, 0, 0};

   const float SmearingTool::ERRmean[104]={
                   6.03225e-05, 5.15692e-05, 4.65183e-05, 4.30289e-05, 5.39083e-05, 9.30038e-05, 0.000145211, 0.000207904, 0.000284236, 0.000296055, 0.000416457, 0.00075122, 0.00275942, 
                   5.90028e-05, 4.9647e-05, 4.29589e-05, 3.74544e-05, 4.62224e-05, 7.79517e-05, 0.0001216, 0.000169743, 0.000229803, 0.000236961, 0.000322733, 0.000567071, 0.00173861, 
                   4.79807e-05, 3.99346e-05, 3.36108e-05, 2.9652e-05, 3.80223e-05, 6.4646e-05, 9.946e-05, 0.000141897, 0.000191152, 0.000202416, 0.000286606, 0.000521026, 0.00156513, 
                   2.28103e-05, 1.8055e-05, 1.58284e-05, 1.52975e-05, 2.02324e-05, 3.47e-05, 5.38989e-05, 7.70981e-05, 0.00010557, 0.000111961, 0.00015988, 0.000293032, 0.000861781, 
                   2.29435e-05, 1.81283e-05, 1.58902e-05, 1.53577e-05, 2.03138e-05, 3.47465e-05, 5.40937e-05, 7.74434e-05, 0.00010613, 0.000113047, 0.000159846, 0.000297573, 0.000916825, 
                   4.86003e-05, 4.01301e-05, 3.38705e-05, 2.99887e-05, 3.83925e-05, 6.54571e-05, 0.000101258, 0.000145222, 0.000196538, 0.00020338, 0.000286076, 0.000529727, 0.00159373, 
                   5.87954e-05, 4.97567e-05, 4.30879e-05, 3.7588e-05, 4.61635e-05, 7.89422e-05, 0.000121359, 0.000173544, 0.000227979, 0.000240954, 0.000325174, 0.000574093, 0.00177143, 
                   5.94951e-05, 5.1226e-05, 4.63272e-05, 4.28642e-05, 5.35803e-05, 9.23932e-05, 0.000144489, 0.000209744, 0.000285766, 0.000293635, 0.000419028, 0.000794003, 0.00281443};
   const float SmearingTool::ERRsig1[104]={
                   0.000170958, 0.000151745, 0.000144915, 0.000138761, 0.000200699, 0.000439146, 0.00023731, 0.000965836, 0.000476934, 0.000216315, 0.000313822, 0.000610649, 0.00283054, 
                   0.000114362, 9.75771e-05, 8.72187e-05, 7.94373e-05, 9.65439e-05, 0.000152681, 0.000269476, 0.000324429, 0.000680687, 0.000169468, 0.000233352, 0.000431697, 0.00158432, 
                   8.16197e-05, 6.91789e-05, 5.77857e-05, 5.54071e-05, 7.31691e-05, 0.000119233, 0.000208301, 0.000406495, 0.000392474, 0.00047626, 0.00105357, 0.00106883, 0.00144831, 
                   2.89396e-05, 2.19347e-05, 1.96645e-05, 1.8776e-05, 2.48437e-05, 4.57412e-05, 6.90499e-05, 0.000108147, 0.000152918, 0.000199583, 0.000291914, 0.000870384, 0.000737426, 
                   2.91543e-05, 2.31553e-05, 2.0556e-05, 1.97617e-05, 2.69384e-05, 4.67667e-05, 7.71858e-05, 0.000105861, 0.000141163, 0.000173823, 0.000383045, 0.000722025, 0.000810109, 
                   8.56981e-05, 6.93225e-05, 6.07596e-05, 5.39035e-05, 7.28238e-05, 0.000137585, 0.000228975, 0.000380386, 0.000536683, 0.000383244, 0.0010555, 0.00614397, 0.0015016, 
                   0.000119211, 0.000109869, 8.58815e-05, 7.6067e-05, 9.57123e-05, 0.000189737, 0.000225756, 0.000455112, 0.000959067, 0.000172412, 0.000235184, 0.000438737, 0.0016272, 
                   0.000162247, 0.000137633, 0.000155536, 0.000140582, 0.000207575, 0.000405387, 0.00028306, 0.00033591, 0.00124338, 0.000214605, 0.000316987, 0.000664521, 0.00295257};
   const float SmearingTool::ERRsig2[104]={
                   0.000592915, 0.000613286, 0.00053482, 0.000548958, 0.000706513, 0.000989313, 0.000270093, 0.00448188, 0.000565649, 0, 0, 0, 0, 
                   0.000767416, 0.000722769, 0.000645432, 0.00064419, 0.000852031, 0.00190873, 0.00281319, 0.00787107, 0.00443061, 0, 0, 0, 0, 
                   0.000530688, 0.000476165, 0.000418023, 0.000365685, 0.000505111, 0.000952827, 0.00155433, 0.00150252, 0.0040876, 0.00570169, 0.0073426, 0.00162597, 0, 
                   0.000275445, 0.000228092, 0.000199383, 0.00021063, 0.000302515, 0.000459203, 0.000904965, 0.00125538, 0.00182178, 0.00178464, 0.00477884, 0.0244558, 0, 
                   0.00028305, 0.000214883, 0.000189038, 0.000192998, 0.000266215, 0.000464229, 0.000798933, 0.00125451, 0.00274573, 0.00248178, 0.00217004, 0.0740579, 0, 
                   0.000531294, 0.000469912, 0.000389796, 0.000365304, 0.000481483, 0.000832219, 0.00145385, 0.00205765, 0.00293548, 0.00820971, 0.0125559, 0.0334861, 0, 
                   0.000692284, 0.00058438, 0.000633761, 0.000659596, 0.000920157, 0.00149581, 0.004316, 0.00442788, 0.00199914, 0, 0, 0, 0, 
                   0.000581654, 0.000633973, 0.000494483, 0.000513696, 0.000636448, 0.000888969, 0.000391274, 0.000385188, 0.0056216, 0, 0, 0, 0};
   const float SmearingTool::ERRAsig2[104]={
                   0.0214972, 0.0181546, 0.0180282, 0.0168801, 0.026799, 0.0696046, 0.285448, 0.112995, 0.298785, 0, 0, 0, 0, 
                   0.0095489, 0.00778733, 0.00696794, 0.00635022, 0.00742618, 0.0101339, 0.0210884, 0.0177931, 0.0677013, 0, 0, 0, 0, 
                   0.00644363, 0.00522314, 0.00410875, 0.00428862, 0.0057605, 0.00845663, 0.0164185, 0.0477964, 0.0283871, 0.0318772, 0.106235, 0.382016, 0, 
                   0.00167115, 0.00109735, 0.000984978, 0.00087481, 0.00109691, 0.00233667, 0.00312142, 0.00547411, 0.00765196, 0.0128805, 0.0162296, 0.0492034, 0, 
                   0.00168288, 0.00131897, 0.0011433, 0.00104213, 0.00141759, 0.00247101, 0.00416532, 0.00524789, 0.00584595, 0.00882335, 0.0345201, 0.0337194, 0, 
                   0.00691464, 0.00512476, 0.00469736, 0.00406107, 0.00560724, 0.0115982, 0.0194353, 0.0364282, 0.0523126, 0.0199269, 0.0828346, 0.257134, 0, 
                   0.0108335, 0.0106325, 0.00668975, 0.00580412, 0.00710823, 0.0159826, 0.0126424, 0.0381291, 0.29747, 0, 0, 0, 0, 
                   0.0191661, 0.0147114, 0.0202739, 0.0173166, 0.0284776, 0.0621407, 0.325158, 0.31087, 0.133184, 0, 0, 0, 0};

   const float SmearingTool::ResRMS[104]={
                   0.0213705, 0.0226962, 0.0235394, 0.0243347, 0.025085, 0.0260635, 0.0271216, 0.0280823, 0.0289924, 0.0305302, 0.0332952, 0.0376531, 0.0455497, 
                   0.0198919, 0.0210258, 0.0216035, 0.0223093, 0.0230206, 0.0236592, 0.0244445, 0.0251006, 0.0259285, 0.0272687, 0.0292082, 0.0340249, 0.0420899, 
                   0.0169424, 0.0179766, 0.0187979, 0.0195693, 0.0203604, 0.0212509, 0.0220375, 0.0229798, 0.0237745, 0.025364, 0.0281083, 0.0338164, 0.0425713, 
                   0.0126815, 0.0136332, 0.0145164, 0.0154004, 0.016304, 0.0172494, 0.0182192, 0.019038, 0.0201048, 0.0214842, 0.0243478, 0.0301223, 0.0398399, 
                   0.0126466, 0.0136083, 0.0145067, 0.0153544, 0.0162298, 0.0171611, 0.0181081, 0.019107, 0.0200403, 0.0216637, 0.0241318, 0.0301855, 0.0410237, 
                   0.0171139, 0.018116, 0.0189223, 0.0197665, 0.0205349, 0.0214153, 0.0224372, 0.0235047, 0.0244026, 0.0257633, 0.0279222, 0.0339378, 0.0431269, 
                   0.019768, 0.0209026, 0.0215499, 0.0222376, 0.0228696, 0.0236667, 0.0245564, 0.025267, 0.0257635, 0.0273873, 0.0292322, 0.0342779, 0.0423192, 
                   0.0214313, 0.0227803, 0.0237307, 0.0245372, 0.0252486, 0.0262597, 0.0273071, 0.0285252, 0.0295464, 0.0305564, 0.0335718, 0.0389545, 0.045871};
   const float SmearingTool::ErrResRMS[104]={
                   4.33694e-05, 3.69818e-05, 3.32975e-05, 3.07092e-05, 3.83271e-05, 6.59871e-05, 0.000102529, 0.00014608, 0.000198123, 0.000206625, 0.000285651, 0.000488056, 0.00136594, 
                   4.25912e-05, 3.58366e-05, 3.09853e-05, 2.69059e-05, 3.31793e-05, 5.57895e-05, 8.65803e-05, 0.000120618, 0.000162658, 0.000166888, 0.000226318, 0.000386547, 0.00101252, 
                   3.50425e-05, 2.91148e-05, 2.45475e-05, 2.15768e-05, 2.75596e-05, 4.6943e-05, 7.17708e-05, 0.000102021, 0.000136929, 0.00014444, 0.00020002, 0.000349759, 0.000902713, 
                   1.705e-05, 1.35449e-05, 1.18481e-05, 1.1422e-05, 1.50904e-05, 2.58183e-05, 3.99065e-05, 5.67613e-05, 7.77655e-05, 8.14753e-05, 0.000114866, 0.000202688, 0.000536129, 
                   1.71024e-05, 1.35281e-05, 1.18509e-05, 1.14171e-05, 1.50684e-05, 2.57382e-05, 3.98293e-05, 5.71002e-05, 7.76848e-05, 8.23841e-05, 0.000114903, 0.000205825, 0.000553667, 
                   3.54823e-05, 2.93393e-05, 2.47258e-05, 2.18575e-05, 2.79232e-05, 4.73878e-05, 7.30128e-05, 0.000104409, 0.000140556, 0.000145298, 0.000199924, 0.000349596, 0.000902798, 
                   4.25012e-05, 3.58837e-05, 3.11232e-05, 2.70364e-05, 3.3111e-05, 5.64773e-05, 8.67984e-05, 0.000122896, 0.000161489, 0.000169692, 0.000227918, 0.000390278, 0.00103003, 
                   4.2815e-05, 3.68025e-05, 3.31953e-05, 3.06285e-05, 3.81863e-05, 6.56152e-05, 0.000102063, 0.000147547, 0.000199202, 0.000204869, 0.000286677, 0.000503825, 0.00141025};

   ////// End smearing parametrization for single muon:

SmearingTool::SmearingTool(){
}
float SmearingTool::PTsmear(float PTmuonGen, float ETAmuonGen, float CHARGEmuonGen, float PTmuonReco, int Ismear, float ParSig, TString ParVar){
   //Ismear = 1 - Smear with RND (no RECO use), Ismear = 2 - Smear with SF for RECO and GEN
   if(Ismear != 1 && Ismear != 2)std::cout << "ERROR SmearingTool::PTsmear: set Ismear to 1 or 2 for smearing" << std::endl;
   const int NPThist = (sizeof(PTbin)/sizeof(float)-1);
   const int NETAhist = (sizeof(ETAbin)/sizeof(float)-1);
   //const int Nhist = NPThist*NETAhist;
   ////// Make smearing for single muon from Gen level PostFSR:
   float PTmuonSmear = -10.;
   float meanVar = 0;
   float sigVar = 0;//for sig1 and sig2
   float Asig2Var = 0;
   if(ParVar == "mean")meanVar = ParSig;
   if(ParVar == "sig1" || ParVar == "sig2")sigVar = ParSig;
   if(ParVar == "Asig2Var")Asig2Var = ParSig;
   int iK_cand = -1;
   for(int iPT = 0; iPT < NPThist; iPT++){
   for(int iETA = 0; iETA < NETAhist; iETA++){
      int iK = iPT + iETA*NPThist;
      // smear muons which out of range PT and ETA
      float PTcutDown = PTbin[iPT];
      float PTcutUp = PTbin[iPT+1];
      if(iPT == 0 && PTmuonGen < PTbin[0])PTcutDown = PTmuonGen-0.001;
      if(iPT == (NPThist-1) && PTmuonGen > PTbin[NPThist])PTcutUp = PTmuonGen+0.001;
      float ETAcutDown = ETAbin[iETA];
      float ETAcutUp = ETAbin[iETA+1];
      if(iETA == 0 && ETAmuonGen < ETAbin[0])ETAcutDown = ETAmuonGen-0.001;
      if(iETA == (NETAhist-1) && ETAmuonGen >= ETAbin[NETAhist])ETAcutUp = ETAmuonGen+0.001;
      if(PTmuonGen >= PTcutDown && PTmuonGen < PTcutUp
      && ETAmuonGen >= ETAcutDown && ETAmuonGen < ETAcutUp) iK_cand = iK;
   }}

   ///// Set Scale Factor
   float ScaleFactor = 1.;
   if (fabs(ETAmuonGen) < 0.8) ScaleFactor = 0.92;
   if (fabs(ETAmuonGen) >= 0.8 && fabs(ETAmuonGen) < 1.2) ScaleFactor = 0.99;
   if (fabs(ETAmuonGen) >= 1.2) ScaleFactor = 1.045;
   TF1* fitDoubleGauss = new TF1("fitDoubleGauss", DoubleGauss, -0.1, 0.1, 5);
   fitDoubleGauss->SetParameter(4,1.);
   if(iK_cand > -1 && Ismear == 1){
      float meanCorr = mean[iK_cand] + meanVar*ERRmean[iK_cand];
      float sig1Corr = sig1[iK_cand] + sigVar*ERRsig1[iK_cand];
      if(sig1Corr < 0.005) sig1Corr = 0.005;
      float sig2Corr = sig2[iK_cand] + sigVar*ERRsig2[iK_cand];
      if(sig2Corr < 0.005) sig2Corr = 0.005;
      float Asig2Corr = Asig2[iK_cand] + Asig2Var*ERRAsig2[iK_cand];
      if(Asig2Corr < 0.) Asig2Corr = 0.;
      fitDoubleGauss->SetParameter(0,meanCorr);
      fitDoubleGauss->SetParameter(1,ScaleFactor*sig1Corr);
      fitDoubleGauss->SetParameter(2,Asig2Corr);
      fitDoubleGauss->SetParameter(3,ScaleFactor*sig2Corr);
      Double_t resSim = fitDoubleGauss->GetRandom();
      PTmuonSmear = PTmuonGen*(1+resSim);
   }
   delete fitDoubleGauss;
   if(iK_cand > -1 && Ismear == 2){
     PTmuonSmear = PTmuonGen + (ScaleFactorParSig)*(PTmuonReco - PTmuonGen);
   }
   ////// End Smearing parametrization for single muon:

   return PTmuonSmear;
 }//end PTsmear function

   Double_t DoubleGauss(Double_t *x, Double_t *par)
   {
       double dgauss = 0.;
        if(par[1] < par[3]){//not normalized gauss both gauss are  = 1 at x[0]=par[0]
                  dgauss =  exp(-0.5*(x[0]-par[0])*(x[0]-par[0])/par[1]/par[1]);
                  dgauss = dgauss + par[2]*exp(-0.5*(x[0]-par[0])*(x[0]-par[0])/par[3]/par[3]);
                  dgauss = par[4]*dgauss;
        }
       return dgauss;
   }
