#include <SmearingTool.h>

// couldn't be inside class due to root feacher during TF1 creation:
Double_t DoubleGauss(Double_t*, Double_t* );

   const float SmearingTool::PTbin[14]={25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 80, 100, 150, 300};
   const float SmearingTool::ETAbin[9]={-2.1, -1.6, -1.2, -0.8, 0, 0.8, 1.2, 1.6, 2.1};

   ////// Smearing parametrization for single muon:
   const float SmearingTool::mean[104]={
                   -0.000622416, -0.0018992, -0.00206961, -0.00203555, -0.00198291, -0.00218934, -0.0025628, -0.00258265, -0.00276355, -0.0032292, -0.0029984, -0.00376548, -0.00840925, 
                   -0.000426198, -0.0015471, -0.00148278, -0.00151697, -0.00143914, -0.00170943, -0.00136864, -0.00167944, -0.0017073, -0.00128322, -0.00139513, -0.00206585, -0.00372609, 
                   -0.000281871, -0.00104274, -0.000995849, -0.0010574, -0.00108209, -0.0011549, -0.00110516, -0.00131146, -0.00111293, -0.00119864, -0.00111327, -0.00143643, -0.00299718, 
                   -0.00066688, -0.000892011, -0.000894066, -0.000904272, -0.000923584, -0.000980611, -0.00088481, -0.000971572, -0.00095131, -0.00100477, -0.000928566, -0.00116721, -0.00198719, 
                   -0.000616907, -0.000907318, -0.00091748, -0.000919447, -0.000932883, -0.000982918, -0.000970885, -0.00104313, -0.00106354, -0.00101402, -0.00102077, -0.001249, -0.000868618, 
                   -0.000324175, -0.0010239, -0.00105929, -0.00107092, -0.00113964, -0.00115629, -0.00118838, -0.00145661, -0.00118967, -0.00139471, -0.000950911, -0.0013537, -0.00133929, 
                   -0.000429035, -0.00146334, -0.00150448, -0.00147234, -0.00152036, -0.00162369, -0.00151407, -0.00181982, -0.00164753, -0.00141688, -0.00122145, -0.0013685, 0.000255513, 
                   -0.000736595, -0.00188389, -0.00202286, -0.00200716, -0.00212761, -0.00208491, -0.00257041, -0.00273779, -0.00207021, -0.00227316, -0.00293357, -0.00355798, -0.00439574};
   const float SmearingTool::sig1[104]={
                   0.0192151, 0.0208812, 0.0210884, 0.0219377, 0.0228174, 0.0232003, 0.0234021, 0.0237774, 0.026266, 0.0314129, 0.0344805, 0.040264, 0.0564414, 
                   0.0188729, 0.0198672, 0.020255, 0.0208769, 0.0214158, 0.0217737, 0.0227775, 0.0230835, 0.0237939, 0.0265367, 0.0283575, 0.0319244, 0.0424571, 
                   0.0157488, 0.0166513, 0.0170573, 0.017569, 0.0181204, 0.0183602, 0.0190046, 0.0198883, 0.0209082, 0.0208823, 0.0232612, 0.0276957, 0.0396195, 
                   0.0109142, 0.0114939, 0.0120499, 0.0126036, 0.0131017, 0.0135709, 0.0143349, 0.0146651, 0.0153958, 0.0160265, 0.0182943, 0.020523, 0.0335092, 
                   0.0106873, 0.011218, 0.011711, 0.0123056, 0.0128032, 0.013334, 0.0138919, 0.0145632, 0.0151104, 0.0158967, 0.0174833, 0.0203687, 0.0333581, 
                   0.0155951, 0.0164325, 0.0168342, 0.0174453, 0.0178764, 0.0184794, 0.0189789, 0.019724, 0.0205108, 0.021053, 0.0235291, 0.0252053, 0.0396318, 
                   0.0190976, 0.0199624, 0.0206866, 0.0216561, 0.0218612, 0.0226182, 0.0234122, 0.0230149, 0.0243799, 0.0274551, 0.0287062, 0.0330026, 0.0414095, 
                   0.0199835, 0.0209276, 0.0212345, 0.0221732, 0.0226315, 0.0239702, 0.023767, 0.0243418, 0.0280745, 0.0316114, 0.0344327, 0.0398121, 0.0556895};
   const float SmearingTool::sig2[104]={
                   0.0308314, 0.0333353, 0.0333518, 0.0353964, 0.0365163, 0.0370027, 0.035976, 0.0372425, 0.0424388, 3, 3, 3, 3, 
                   0.0326593, 0.0357809, 0.0367824, 0.0379023, 0.0386681, 0.0405296, 0.0470587, 0.0436918, 0.0525777, 3, 3, 3, 3, 
                   0.0291049, 0.0315544, 0.0325872, 0.0324462, 0.033564, 0.0338432, 0.0343663, 0.0369304, 0.0430993, 0.0379884, 0.0411439, 0.0483075, 3, 
                   0.0252529, 0.0273125, 0.0287295, 0.0305008, 0.0320202, 0.0321128, 0.0352719, 0.0345378, 0.0370946, 0.0374961, 0.0504632, 0.0400514, 3, 
                   0.0246483, 0.0260157, 0.0269355, 0.0290358, 0.0302441, 0.0318724, 0.0326432, 0.0344636, 0.0358862, 0.0378043, 0.0398283, 0.0394843, 3, 
                   0.0288057, 0.0311467, 0.0313775, 0.0333493, 0.0336563, 0.0333224, 0.0343968, 0.035782, 0.0411258, 0.0389261, 0.046897, 0.0399397, 3, 
                   0.0318825, 0.0326572, 0.0365091, 0.0409026, 0.0391824, 0.0442808, 0.0508702, 0.0377871, 0.0469059, 3, 3, 3, 3, 
                   0.0327697, 0.0339095, 0.0339711, 0.0357776, 0.0363628, 0.0394612, 0.0376704, 0.0380317, 0.0600602, 3, 3, 3, 3};
   const float SmearingTool::Asig2[104]={
                   0.250621, 0.217013, 0.269575, 0.225977, 0.202378, 0.248898, 0.4, 0.4, 0.196311, 0, 0, 0, 0, 
                   0.0773437, 0.0652636, 0.0668376, 0.0630873, 0.0645034, 0.0615381, 0.0378527, 0.0552392, 0.0350517, 0, 0, 0, 0, 
                   0.0640661, 0.0556873, 0.0623548, 0.0735858, 0.0734369, 0.0933928, 0.0939238, 0.079588, 0.0436552, 0.110167, 0.117042, 0.111886, 0, 
                   0.0351408, 0.0340863, 0.034602, 0.0332148, 0.0339219, 0.0411044, 0.0340523, 0.0427914, 0.0399595, 0.0471854, 0.0279435, 0.131696, 0, 
                   0.0366355, 0.0391316, 0.0427975, 0.0378172, 0.0389384, 0.0385695, 0.0425137, 0.0406802, 0.0388495, 0.045095, 0.0563305, 0.135675, 0, 
                   0.07309, 0.0642598, 0.0774351, 0.0693682, 0.0778367, 0.0920934, 0.099923, 0.10409, 0.0625069, 0.106268, 0.0628828, 0.4, 0, 
                   0.09395, 0.112898, 0.0752164, 0.0468288, 0.0650728, 0.0466801, 0.0341868, 0.118661, 0.050657, 0, 0, 0, 0, 
                   0.171674, 0.207606, 0.270871, 0.224193, 0.238684, 0.173185, 0.315822, 0.4, 0.0510828, 0, 0, 0, 0};

   const float SmearingTool::ERRmean[104]={
                   6.5628e-05, 5.59835e-05, 4.99914e-05, 4.60329e-05, 5.71751e-05, 9.83291e-05, 0.000153112, 0.000216764, 0.00029683, 0.000303598, 0.000427395, 0.000777052, 0.00295772, 
                   6.26589e-05, 5.2089e-05, 4.48382e-05, 3.8718e-05, 4.74826e-05, 7.92214e-05, 0.000122622, 0.000170233, 0.000228432, 0.000230235, 0.0003114, 0.000517743, 0.00151782, 
                   5.04181e-05, 4.14135e-05, 3.45231e-05, 3.01766e-05, 3.82357e-05, 6.44373e-05, 9.78419e-05, 0.000138677, 0.000184785, 0.000191492, 0.000266342, 0.000457525, 0.00122846, 
                   2.25556e-05, 1.75476e-05, 1.51267e-05, 1.43631e-05, 1.86783e-05, 3.15952e-05, 4.83866e-05, 6.81365e-05, 9.2683e-05, 9.53959e-05, 0.000132873, 0.000231403, 0.0006418, 
                   2.22668e-05, 1.72475e-05, 1.48677e-05, 1.41412e-05, 1.84079e-05, 3.09867e-05, 4.76017e-05, 6.76147e-05, 9.07709e-05, 9.48817e-05, 0.000132364, 0.000232519, 0.000637797, 
                   5.04967e-05, 4.12681e-05, 3.44759e-05, 3.01288e-05, 3.82108e-05, 6.45595e-05, 9.82283e-05, 0.000139945, 0.00018509, 0.000191578, 0.000264427, 0.000459826, 0.0012184, 
                   6.39722e-05, 5.36419e-05, 4.62135e-05, 4.00121e-05, 4.86691e-05, 8.25212e-05, 0.000125734, 0.000176383, 0.000235037, 0.000241617, 0.000318623, 0.000537818, 0.0014755, 
                   6.52564e-05, 5.57232e-05, 5.00846e-05, 4.59682e-05, 5.7103e-05, 9.78504e-05, 0.000152567, 0.000220744, 0.000296226, 0.000302702, 0.000424237, 0.000764993, 0.00290992};
   const float SmearingTool::ERRsig1[104]={
                   0.00023108, 0.00020695, 0.00019969, 0.000179278, 0.00023042, 0.000415544, 0.00025147, 0.000358756, 0.0013987, 0.000223309, 0.000324844, 0.0006414, 0.00315364, 
                   0.000136925, 0.000107287, 9.37362e-05, 8.32807e-05, 0.000103935, 0.000170216, 0.000241479, 0.000379342, 0.00048016, 0.000164161, 0.000223853, 0.000382484, 0.00129779, 
                   9.0033e-05, 7.13447e-05, 6.04419e-05, 5.76699e-05, 7.46562e-05, 0.000131038, 0.000204444, 0.000304993, 0.000363527, 0.000470895, 0.000782008, 0.00234996, 0.00100374, 
                   2.83433e-05, 2.14688e-05, 1.82622e-05, 1.72748e-05, 2.23532e-05, 3.98737e-05, 5.74306e-05, 8.85177e-05, 0.000119911, 0.000128109, 0.000167098, 0.000539676, 0.000482087, 
                   2.82253e-05, 2.19738e-05, 1.89452e-05, 1.76097e-05, 2.29554e-05, 3.80075e-05, 6.11959e-05, 8.64457e-05, 0.00011837, 0.00012769, 0.000197522, 0.000514806, 0.000478163, 
                   9.38946e-05, 7.26131e-05, 6.33361e-05, 5.37188e-05, 7.25471e-05, 0.000135267, 0.000219588, 0.000343775, 0.000350721, 0.000437246, 0.000611752, 0.000973368, 0.00099563, 
                   0.000156277, 0.000143148, 0.000103522, 8.12272e-05, 0.000112382, 0.00017896, 0.000236102, 0.000576437, 0.000538483, 0.000172911, 0.000229496, 0.000401665, 0.0012405, 
                   0.000199308, 0.000191979, 0.000197256, 0.000175221, 0.000231323, 0.000377068, 0.000835257, 0.000366359, 0.00119445, 0.000222971, 0.000322248, 0.00062698, 0.00310071};
   const float SmearingTool::ERRsig2[104]={
                   0.000563839, 0.000623865, 0.000500852, 0.000553875, 0.000829046, 0.00127659, 0.000291775, 0.000418407, 0.00661253, 0, 0, 0, 0, 
                   0.000928624, 0.000916598, 0.000814651, 0.000796974, 0.00101757, 0.00183583, 0.00490306, 0.00511389, 0.0128409, 0, 0, 0, 0, 
                   0.000619276, 0.000573212, 0.000456758, 0.000385917, 0.000517632, 0.000757663, 0.00122046, 0.00223907, 0.00535278, 0.00280869, 0.00514075, 0.022076, 0, 
                   0.000271742, 0.000213936, 0.000184241, 0.000184262, 0.00024276, 0.000379587, 0.00068678, 0.000877283, 0.00134841, 0.00131212, 0.00414404, 0.00286787, 0, 
                   0.000261232, 0.000195411, 0.000160585, 0.000166844, 0.000218119, 0.000377422, 0.000573596, 0.000884653, 0.00130641, 0.0013513, 0.00193998, 0.00265344, 0, 
                   0.00057157, 0.000515214, 0.000393786, 0.000383339, 0.000478377, 0.000787358, 0.00122509, 0.00193604, 0.00358847, 0.00275894, 0.00830774, 0.00150377, 0, 
                   0.000904323, 0.000738729, 0.000824392, 0.00110954, 0.0011227, 0.00279119, 0.00603924, 0.00346338, 0.00907228, 0, 0, 0, 0, 
                   0.000711885, 0.000608605, 0.000498319, 0.000554034, 0.000713047, 0.00173506, 0.00209811, 0.000437919, 0.031287, 0, 0, 0, 0};
   const float SmearingTool::ERRAsig2[104]={
                   0.0333731, 0.0283208, 0.0295865, 0.0236336, 0.0300422, 0.0568329, 0.246098, 0.0819303, 0.153653, 0, 0, 0, 0, 
                   0.0126178, 0.00857046, 0.00737063, 0.00647818, 0.00820813, 0.0124773, 0.0136943, 0.0264745, 0.0249069, 0, 0, 0, 0, 
                   0.00739856, 0.00517434, 0.00435359, 0.00458156, 0.00581836, 0.0107728, 0.0174302, 0.0234381, 0.020608, 0.0399645, 0.0695069, 0.242042, 0, 
                   0.0015953, 0.00108398, 0.000884649, 0.000779194, 0.000970109, 0.00188458, 0.00236354, 0.00410728, 0.00516741, 0.00596539, 0.00560717, 0.0410823, 0, 
                   0.00164451, 0.00122892, 0.00106265, 0.000874731, 0.00111488, 0.00175459, 0.0029026, 0.00392962, 0.00522325, 0.00573346, 0.00981566, 0.0402137, 0, 
                   0.00793199, 0.00545298, 0.00507067, 0.00391352, 0.0055377, 0.0116556, 0.0187589, 0.0291704, 0.0219771, 0.0353345, 0.0400335, 0.385008, 0, 
                   0.0164226, 0.0161791, 0.0088514, 0.00554956, 0.00904138, 0.0115262, 0.0123268, 0.0620187, 0.0365144, 0, 0, 0, 0, 
                   0.0243049, 0.0248999, 0.028226, 0.0229736, 0.0311033, 0.0438679, 0.112643, 0.257377, 0.0717515, 0, 0, 0, 0};

   const float SmearingTool::ResRMS[104]={
                   0.0230572, 0.0245172, 0.0251848, 0.025924, 0.026475, 0.0273933, 0.0284075, 0.0291166, 0.0300034, 0.0311525, 0.0338589, 0.0383194, 0.0464229, 
                   0.0208961, 0.0219267, 0.0224306, 0.0229746, 0.0235315, 0.0240054, 0.0246707, 0.0252126, 0.0257935, 0.0264966, 0.028256, 0.0316068, 0.0397723, 
                   0.0176111, 0.0185377, 0.0192324, 0.019857, 0.0204764, 0.0212094, 0.0217644, 0.0225642, 0.0230722, 0.0242172, 0.0265699, 0.030612, 0.0378821, 
                   0.0125516, 0.0133186, 0.0140027, 0.0146559, 0.0153251, 0.0160269, 0.0167627, 0.0173163, 0.0181373, 0.0190065, 0.0210873, 0.0251277, 0.0330297, 
                   0.0123303, 0.0130798, 0.0137527, 0.0143899, 0.0150248, 0.0156928, 0.0164156, 0.0171306, 0.0176599, 0.0188801, 0.0208324, 0.0249675, 0.0329407, 
                   0.0176529, 0.0185427, 0.0192135, 0.019867, 0.0204566, 0.0211177, 0.0218933, 0.0228067, 0.0232545, 0.0244594, 0.0262433, 0.0308419, 0.0379268, 
                   0.0212114, 0.0223181, 0.0229104, 0.023485, 0.02396, 0.0246268, 0.0253192, 0.025682, 0.0264111, 0.0273868, 0.0286062, 0.0325942, 0.0391716, 
                   0.0232621, 0.0246446, 0.025523, 0.0261587, 0.0267714, 0.0275971, 0.0285945, 0.0296856, 0.0303119, 0.031332, 0.0338073, 0.0380099, 0.0463303};
   const float SmearingTool::ErrResRMS[104]={
                   4.70751e-05, 3.99814e-05, 3.56414e-05, 3.27281e-05, 4.04689e-05, 6.93819e-05, 0.000107395, 0.000151604, 0.000205339, 0.000211108, 0.000291433, 0.000497529, 0.00139213, 
                   4.49193e-05, 3.73884e-05, 3.21818e-05, 2.77114e-05, 3.39195e-05, 5.66102e-05, 8.73718e-05, 0.000121013, 0.000161773, 0.000162351, 0.000218783, 0.000359029, 0.000941636, 
                   3.65429e-05, 3.00369e-05, 2.51224e-05, 2.18964e-05, 2.77181e-05, 4.68655e-05, 7.08829e-05, 0.000100166, 0.000133008, 0.000138017, 0.000189092, 0.000316109, 0.00079405, 
                   1.69097e-05, 1.32414e-05, 1.14329e-05, 1.08718e-05, 1.4187e-05, 2.39929e-05, 3.6724e-05, 5.16264e-05, 7.01891e-05, 7.21323e-05, 9.95725e-05, 0.000168951, 0.000440985, 
                   1.67074e-05, 1.3011e-05, 1.12398e-05, 1.0702e-05, 1.39515e-05, 2.35386e-05, 3.61169e-05, 5.12016e-05, 6.84861e-05, 7.18535e-05, 9.93056e-05, 0.000170095, 0.000439326, 
                   3.67032e-05, 3.0042e-05, 2.51121e-05, 2.19722e-05, 2.78214e-05, 4.67277e-05, 7.12333e-05, 0.00010134, 0.000133983, 0.000138107, 0.000188309, 0.0003172, 0.000788774, 
                   4.58077e-05, 3.83409e-05, 3.30966e-05, 2.85608e-05, 3.46958e-05, 5.87768e-05, 8.94779e-05, 0.000124926, 0.000165581, 0.000170095, 0.000223786, 0.000370915, 0.000933187, 
                   4.67372e-05, 3.98445e-05, 3.57186e-05, 3.26662e-05, 4.05029e-05, 6.89909e-05, 0.000106817, 0.000153566, 0.0002044, 0.000210306, 0.0002893, 0.000492929, 0.00141636};

   ////// End smearing parametrization for single muon:

SmearingTool::SmearingTool(){
}
float SmearingTool::PTsmear(float PTmuonGen, float ETAmuonGen, float CHARGEmuonGen, float PTmuonReco, int Ismear, float ParSig, TString ParVar){
   //Ismear = 1 - Smear with RND (no RECO use), Ismear = 2 - Smear with SF for RECO and GEN
   if(Ismear != 1 && Ismear != 2)std::cout << "ERROR SmearingTool::PTsmear: set Ismear to 1 or 2 for smearing" << std::endl;
   const int NPThist = (sizeof(PTbin)/sizeof(float)-1);
   const int NETAhist = (sizeof(ETAbin)/sizeof(float)-1);
   //const int Nhist = NPThist*NETAhist;
   ////// Make smearing for single muon from Gen level PostFSR:
   float PTmuonSmear = -10.;
   float meanVar = 0;
   float sigVar = 0;//for sig1 and sig2
   float Asig2Var = 0;
   if(ParVar == "mean")meanVar = ParSig;
   if(ParVar == "sig1" || ParVar == "sig2")sigVar = ParSig;
   if(ParVar == "Asig2Var")Asig2Var = ParSig;
   int iK_cand = -1;
   for(int iPT = 0; iPT < NPThist; iPT++){
   for(int iETA = 0; iETA < NETAhist; iETA++){
      int iK = iPT + iETA*NPThist;
      // smear muons which out of range PT and ETA
      float PTcutDown = PTbin[iPT];
      float PTcutUp = PTbin[iPT+1];
      if(iPT == 0 && PTmuonGen < PTbin[0])PTcutDown = PTmuonGen-0.001;
      if(iPT == (NPThist-1) && PTmuonGen > PTbin[NPThist])PTcutUp = PTmuonGen+0.001;
      float ETAcutDown = ETAbin[iETA];
      float ETAcutUp = ETAbin[iETA+1];
      if(iETA == 0 && ETAmuonGen < ETAbin[0])ETAcutDown = ETAmuonGen-0.001;
      if(iETA == (NETAhist-1) && ETAmuonGen >= ETAbin[NETAhist])ETAcutUp = ETAmuonGen+0.001;
      if(PTmuonGen >= PTcutDown && PTmuonGen < PTcutUp
      && ETAmuonGen >= ETAcutDown && ETAmuonGen < ETAcutUp) iK_cand = iK;
   }}

   ///// Set Scale Factor
   float ScaleFactor = 1.;
   if (fabs(ETAmuonGen) < 0.8) ScaleFactor = 0.975;
   if (fabs(ETAmuonGen) >= 0.8 && fabs(ETAmuonGen) < 1.2) ScaleFactor = 0.99; 
   if (fabs(ETAmuonGen) >= 1.2) ScaleFactor = 1.0;
   TF1* fitDoubleGauss = new TF1("fitDoubleGauss", DoubleGauss, -0.1, 0.1, 5);
   fitDoubleGauss->SetParameter(4,1.);
   if(iK_cand > -1 && Ismear == 1){
      float meanCorr = mean[iK_cand] + meanVar*ERRmean[iK_cand];
      float sig1Corr = sig1[iK_cand] + sigVar*ERRsig1[iK_cand];
      if(sig1Corr < 0.005) sig1Corr = 0.005;
      float sig2Corr = sig2[iK_cand] + sigVar*ERRsig2[iK_cand];
      if(sig2Corr < 0.005) sig2Corr = 0.005;
      float Asig2Corr = Asig2[iK_cand] + Asig2Var*ERRAsig2[iK_cand];
      if(Asig2Corr < 0.) Asig2Corr = 0.;
      fitDoubleGauss->SetParameter(0,meanCorr);
      fitDoubleGauss->SetParameter(1,ScaleFactor*sig1Corr);
      fitDoubleGauss->SetParameter(2,Asig2Corr);
      fitDoubleGauss->SetParameter(3,ScaleFactor*sig2Corr);
      Double_t resSim = fitDoubleGauss->GetRandom();
      PTmuonSmear = PTmuonGen*(1+resSim);
   }
   delete fitDoubleGauss;
   if(iK_cand > -1 && Ismear == 2){
     PTmuonSmear = PTmuonGen + (ScaleFactor+ParSig)*(PTmuonReco - PTmuonGen);
   }
   ////// End Smearing parametrization for single muon:

   return PTmuonSmear;
 }//end PTsmear function

   Double_t DoubleGauss(Double_t *x, Double_t *par)
   {
       double dgauss = 0.;
        if(par[1] < par[3]){//not normalized gauss both gauss are  = 1 at x[0]=par[0]
                  dgauss =  exp(-0.5*(x[0]-par[0])*(x[0]-par[0])/par[1]/par[1]);
                  dgauss = dgauss + par[2]*exp(-0.5*(x[0]-par[0])*(x[0]-par[0])/par[3]/par[3]);
                  dgauss = par[4]*dgauss;
        }
       return dgauss;
   }
